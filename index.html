<!DOCTYPE html>
<html>
  <head>
    <title>Camera Access Example</title>
    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
  </head>
  <body>
    <h1>Camera Access Example</h1>
    <video id="videoElement" autoplay></video>
    <canvas id="canvasElement"></canvas>
    <script>
      const video = document.getElementById("videoElement");
      const canvas = document.getElementById("canvasElement");
      const context = canvas.getContext("2d");

      function onOpenCvReady() {
        // Set up OpenCV.js
        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;
        canvas.width = videoWidth;
        canvas.height = videoHeight;
        const src = new cv.Mat(videoHeight, videoWidth, cv.CV_8UC4);
        const dst = new cv.Mat(videoHeight, videoWidth, cv.CV_8UC1);

        // Load number plate detection model
        cv.FS_createDataFile("/", "haarcascade_russian_plate_number.xml", "<!-- insert model data here -->", true, false);
        const classifier = new cv.CascadeClassifier();
        classifier.load("haarcascade_russian_plate_number.xml");

        // Start video stream
        if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia({ video: { facingMode: "environment" } })
            .then(function (stream) {
              video.srcObject = stream;
              setInterval(detectNumberPlate, 1000 / 30); // Run detection every 30 frames
            })
            .catch(function (err0r) {
              console.log("Something went wrong!", err0r);
            });
        }

        function detectNumberPlate() {
          // Capture current video frame
          context.drawImage(video, 0, 0, videoWidth, videoHeight);
          const imageData = context.getImageData(0, 0, videoWidth, videoHeight);

          // Convert to OpenCV.js Mat format
          src.data.set(imageData.data);
          cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);

          // Detect number plates
          const plates = new cv.RectVector();
          classifier.detectMultiScale(src, plates, 1.1, 3, 0);

          // Draw bounding boxes around number plates
          for (let i = 0; i < plates.size(); i++) {
            const rect = plates.get(i);
            cv.rectangle(dst, { x: rect.x, y: rect.y }, { x: rect.x + rect.width, y: rect.y + rect.height }, [255, 255, 255, 255], -1);
          }

          // Display result on canvas
          cv.imshow(canvas, dst);
        }
      }
    </script>
  </body>
</html>
